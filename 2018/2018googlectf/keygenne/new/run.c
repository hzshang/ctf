/*
 * run.c
 * Copyright (C) 2018 hzshang <hzshang15@gmail.com>
 *
 * Distributed under terms of the MIT license.
 */

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
const unsigned char BPF[]={
0x20,0x00,0x00,0x00,0x04,0x00
,0x00,0x00,0x15,0x00,0x00,0x05,0x3E,0x00,0x00,0xC0,0x20,0x00,0x00,0x00,0x00,0x00
,0x00,0x00,0x35,0x00,0x03,0x00,0x00,0x00,0x00,0x40,0x15,0x00,0x01,0x00,0x5F,0x00
,0x00,0x00,0x06,0x00,0x00,0x00,0x00,0x00,0xFF,0x7F,0x06,0x00,0x00,0x00,0x01,0x00
,0x05,0x00,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x58,0xC3,0xE8,0xF9,0xFF,0xFF
};

void load_bpf(){
	asm(
	"mov $0x9D,%%eax\n"
	"mov $0x26,%%edi\n"
	"mov $0x1,%%esi\n"
	"xor %%rdx,%%rdx\n"
	"xor %%r10,%%r10\n"
	"xor %%r8,%%r8\n"
	"syscall\n"
	"mov $0x13D,%%eax\n"
	"mov $0x1,%%esi\n"
	"xor %%rdi,%%rdi\n"
	"syscall\n"
	"lea %0,%%rax\n"
	"push %%rax\n"
	"push $8\n"
	"mov %%rsp,%%rdx\n"
	"xor %%rsi,%%rsi\n"
	"mov $0x1,%%edi\n"
	"mov $0x13D,%%eax\n"
	"syscall\n"
	"pop %%rax\n"
	"pop %%rax\n"
	::"m"(BPF));

}
int main(int argc,char *argv[],char *env[]){
	load_bpf();
    char *arg[2];
    arg[0]=argv[1];
    arg[1]=argv[2];
    execve("./elf",arg,NULL);
	return 0;
}
